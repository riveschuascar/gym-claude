@page
@model WebUI.Pages.Sales.CreateModel

@{
    ViewData["Title"] = "Nueva venta";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">@ViewData["Title"]</h1>
        <a asp-page="Index" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver
        </a>
    </div>

    @if (TempData["ErrorMessage"] != null)
    {
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    }

    <form method="get" class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="row g-2 align-items-end">
                <div class="col-md-5">
                    <label class="form-label">Buscar cliente</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input asp-for="ClientSearch" class="form-control" placeholder="Nombre o CI/NIT" />
                    </div>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Buscar disciplina</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-filter"></i></span>
                        <input asp-for="DisciplineSearch" class="form-control" placeholder="Nombre" />
                    </div>
                </div>
                <div class="col-md-2 d-grid">
                    <div class="btn-group" role="group">
                        <button type="submit" class="btn btn-secondary">
                            <i class="fas fa-search"></i>
                        </button>
                        <a href='@Url.Page("Create")' class="btn btn-outline-warning" title="Limpiar filtros">
                            <i class="fas fa-eraser"></i>
                        </a>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <div class="text-muted small">Si no encuentras resultados, crea el registro y vuelve a esta pantalla.</div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#clientModal"><i class="fas fa-user-plus"></i> Nuevo cliente</button>
                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#disciplineModal"><i class="fas fa-id-card-alt"></i> Nueva disciplina</button>
                </div>
            </div>
        </div>
    </form>

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <i class="fas fa-cash-register"></i> Datos de la venta
        </div>
        <div class="card-body">
            <form method="post" class="row g-3" id="saleForm">
                <input type="hidden" asp-for="CorrelationId" />
                <input type="hidden" asp-for="OperationId" />

                <div class="col-md-6">
                    <label asp-for="Input.ClientId" class="form-label">Cliente</label>
                    <select asp-for="Input.ClientId" class="form-select" id="clientSelect">
                        <option value="">-- Selecciona un cliente --</option>
                        @foreach (var c in Model.Clients)
        {
            var fullName = $"{c.Name} {c.FirstLastname} {c.SecondLastname}".Trim();
                        <option value="@c.Id" data-name="@fullName" data-ci="@c.Ci">@fullName (@c.Ci)</option>
        }
                    </select>

                    <!-- 游댳 Hidden input -->
                    <input type="hidden" asp-for="Input.ClientId" id="clientHidden" />

                    <span asp-validation-for="Input.ClientId" class="text-danger"></span>
                </div>

                <div class="col-12">
                    <label class="form-label">Detalles de venta (disciplinas)</label>
                    <div id="detailsContainer"></div>
                    <div class="mt-2">
                        <button type="button" id="addDetailBtn" class="btn btn-outline-secondary btn-sm"><i class="fas fa-plus"></i> A침adir disciplina</button>
                    </div>
                </div>

                <div class="col-md-3">
                    <label asp-for="Input.SaleDate" class="form-label">Fecha de venta</label>
                    <input asp-for="Input.SaleDate" class="form-control" type="date" />
                    <span asp-validation-for="Input.SaleDate" class="text-danger"></span>
                </div>


                <div class="col-md-3">
                    <label asp-for="Input.TotalAmount" class="form-label">Total (Bs)</label>
                    <input asp-for="Input.TotalAmount" class="form-control" type="number" step="0.01" min="0" id="totalAmount" readonly />
                    <span asp-validation-for="Input.TotalAmount" class="text-danger"></span>
                </div>

                <div class="col-md-3">
                    <label asp-for="Input.TaxId" class="form-label">CI/NIT</label>
                    <input asp-for="Input.TaxId" class="form-control" />
                    <span asp-validation-for="Input.TaxId" class="text-danger"></span>
                </div>


                <div class="col-md-6">
                    <div class="bg-light border rounded p-3 h-100">
                        <h5 class="fw-semibold">Resumen</h5>
                        <div class="small text-muted">Se actualiza al elegir cliente y disciplinas.</div>
                        <dl class="row mt-2 mb-0">
                            <dt class="col-4">Cliente</dt>
                            <dd class="col-8" id="clientPreview">Selecciona un cliente</dd>
                            <dt class="col-4">CI/NIT</dt>
                            <dd class="col-8" id="clientDoc">-</dd>
                            <dt class="col-4">Disciplinas</dt>
                            <dd class="col-8" id="disciplinePreview">Selecciona una disciplina</dd>
                            <dt class="col-4">Sesiones/mes</dt>
                            <dd class="col-8" id="sessionPreview">-</dd>
                            <dt class="col-4">Total</dt>
                            <dd class="col-8 fw-bold" id="totalPreview">0</dd>
                        </dl>
                    </div>
                </div>

                <div class="col-12 d-flex justify-content-end">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Registrar venta
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="clientModal" tabindex="-1" aria-labelledby="clientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="clientModalLabel"><i class="fas fa-user-plus"></i> Nuevo Cliente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="clientModalBody">
                <div class="text-center p-5"><i class="fas fa-spinner fa-spin fa-2x"></i> Cargando formulario...</div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="disciplineModal" tabindex="-1" aria-labelledby="disciplineModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="disciplineModalLabel"><i class="fas fa-id-card-alt"></i> Nueva Disciplina</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="disciplineModalBody">
                <div class="text-center p-5"><i class="fas fa-spinner fa-spin fa-2x"></i> Cargando formulario...</div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const clientSelect = document.getElementById('clientSelect');
        const totalInput = document.getElementById('totalAmount');
        const detailsContainer = document.getElementById('detailsContainer');
        const addDetailBtn = document.getElementById('addDetailBtn');

        function updateClientInfo() {
            const option = clientSelect.options[clientSelect.selectedIndex];
            const name = option?.getAttribute('data-name') || 'Selecciona un cliente';
            const ci = option?.getAttribute('data-ci') || '-';

            $('#clientPreview').text(name);
            $('#clientDoc').text(ci);

            // Actualizar input de NIT/CI
            if (ci !== '-') {
                $('input[name="Input.TaxId"]').val(ci);
            }

            // 游댳 Actualizar hidden para que Razor Pages reciba el valor
            $('#clientHidden').val(clientSelect.value);

            // Forzar validaci칩n
            const form = $('#saleForm');
            if (form.data('validator')) {
                form.validate().element('#clientSelect');
            }
        }


        function createDetailRow(idx, detail) {
            const wrapper = document.createElement('div');
            wrapper.className = 'row g-2 align-items-end mb-2 detail-row';

            let optionsHtml = '<option value="">-- Selecciona --</option>';
            @foreach (var d in Model.Disciplines) {
                <text>optionsHtml += `<option value="@d.Id" data-price="@d.Price">@d.Name (@(d.Price?.ToString("N2")) Bs)</option>`;</text>
            }

            wrapper.innerHTML = `
                <div class="col-md-5">
                    <label class="form-label">Disciplina</label>
                    <select name="Input.Details[${idx}].DisciplineId" class="form-select detail-discipline" required>
                        ${optionsHtml}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Cantidad</label>
                    <input type="number" name="Input.Details[${idx}].Qty" class="form-control detail-qty" value="${detail?.Qty || 1}" min="1">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Precio</label>
                    <input type="number" name="Input.Details[${idx}].Price" class="form-control detail-price" readonly value="${detail?.Price || ''}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Total</label>
                    <input type="number" name="Input.Details[${idx}].Total" class="form-control detail-total" readonly value="${detail?.Total || ''}">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-row"><i class="fas fa-trash"></i></button>
                </div>
            `;

            detailsContainer.appendChild(wrapper);
            const sel = wrapper.querySelector('.detail-discipline');
            const qtyInp = wrapper.querySelector('.detail-qty');
            const priceInp = wrapper.querySelector('.detail-price');
            const totalRowInp = wrapper.querySelector('.detail-total');

            const calc = () => {
                const p = parseFloat(priceInp.value || 0);
                const q = parseInt(qtyInp.value || 0);
                totalRowInp.value = (p * q).toFixed(2);
                recomputeTotal();
            };

            sel.addEventListener('change', () => {
                const p = sel.options[sel.selectedIndex]?.getAttribute('data-price');
                priceInp.value = p ? parseFloat(p).toFixed(2) : '';
                calc();
            });

            qtyInp.addEventListener('change', calc);
            wrapper.querySelector('.remove-row').addEventListener('click', () => { wrapper.remove(); recomputeTotal(); });

            if (detail?.DisciplineId) {
                $(sel).val(detail.DisciplineId).trigger('change');
            }
        }

        function recomputeTotal() {
            let sum = 0;
            document.querySelectorAll('.detail-total').forEach(i => sum += parseFloat(i.value || 0));
            totalInput.value = sum.toFixed(2);
            if (document.getElementById('totalPreview')) document.getElementById('totalPreview').textContent = sum.toFixed(2) + " Bs";

            if (sum > 0) {
                $(totalInput).removeClass("is-invalid input-validation-error");
                $(`[data-valmsg-for="Input.TotalAmount"]`).text("");
            }
        }

        // --- MANEJO DE MODALES ---
        // --- MANEJO DE MODAL DE NUEVO CLIENTE ---
$('#clientModal').on('show.bs.modal', function () {
    $.get('@Url.Page("/Clients/Create", "Partial")', function (data) {
        $('#clientModalBody').html(data);

        // 游댳 Formulario del modal
        $('#clientModalBody form').on('submit', function (e) {
            e.preventDefault();
            $.ajax({
                url: '@Url.Page("/Clients/Create", null, new { handler = "Post" })',
                type: 'POST',
                data: $(this).serialize(),
                dataType: 'json', // importante
                success: function(res) {
                    if (res.success) {
                        // Cierra el modal
                        $('#clientModal').modal('hide');

                        // A침adir cliente al select
                        const newId = Number(res.newId);
                        const opt = new Option(`${res.fullName} (${res.ci})`, newId, true, true);
                        opt.setAttribute('data-name', res.fullName);
                        opt.setAttribute('data-ci', res.ci);

                        const clientSelect = document.getElementById('clientSelect');
                        clientSelect.add(opt);
                        clientSelect.value = newId;

                        // Actualizar hidden y resumen
                        $('#clientHidden').val(newId);
                        updateClientInfo();
                    } else {
                        // Mostrar errores si los hay
                        alert("Error al crear cliente: " + (res.errors?.join(", ") || "Desconocido"));
                    }
                },
                error: function() {
                    alert("Error al crear cliente. Intente nuevamente.");
                }
            });
        });
    });
});



        // --- SOLUCI칍N FINAL PARA EL BOT칍N REGISTRAR ---
        $('#saleForm').on('submit', function (e) {
            // Si hay un cliente seleccionado, forzamos que pase la validaci칩n
            if ($(clientSelect).val() !== "") {
                $(clientSelect).removeClass("input-validation-error");
            }
            // Si el total es mayor a cero, forzamos que pase
            if (parseFloat(totalInput.value) > 0) {
                $(totalInput).removeClass("input-validation-error");
            }
        });

        addDetailBtn.addEventListener('click', () => createDetailRow(document.querySelectorAll('.detail-row').length, null));
        clientSelect.addEventListener('change', updateClientInfo);

        updateClientInfo();
        createDetailRow(0, null);
    </script>
}