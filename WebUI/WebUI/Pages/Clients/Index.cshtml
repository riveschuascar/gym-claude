@page
@model WebUI.Pages.Clients.IndexModel
@{
    ViewData["Title"] = "Gestión de Clientes";
}

<div class="text-center">
    <h1 class="display-4">Gestión de Clientes</h1>
    <p class="lead text-muted">Lista general de todos los clientes registrados.</p>
    <button type="button" class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#createClientModal">
        + Registrar Nuevo Cliente
    </button>
</div>

@if (TempData["ErrorMessage"] is string err && !string.IsNullOrWhiteSpace(err))
{
<div class="alert alert-danger mt-3" role="alert">
    @err
</div>
}

<div class="card shadow-sm mt-4">
    <div class="card-body">
        <table class="table table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Nombre Completo</th>
                    <th>CI</th>
                    <th>Fecha de nacimiento</th>
                    <th>Nivel</th>
                    <th>Peso actual (Kg)</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var c in Model.Clients)
            {
                <tr>
                    <td>
                        <a asp-page="Details" asp-route-id="@c.Id" class="text-decoration-none">
                            @c.Name @c.FirstLastname @c.SecondLastname
                        </a>
                    </td>
                    <td>@c.Ci</td>
                    <td>@(c.DateBirth?.ToString("d"))</td>
                    <td>
                        @if (!string.IsNullOrWhiteSpace(c.FitnessLevel))
                        {
                        <span class="badge bg-secondary">@c.FitnessLevel</span>
                        }
                    </td>
                    <td>@(c.CurrentWeightKg?.ToString("0.##"))</td>
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <a asp-page="Details" asp-route-id="@c.Id" class="btn btn-sm btn-outline-info" title="Ver">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a asp-page="Edit" asp-route-id="@c.Id" class="btn btn-sm btn-outline-warning">Editar</a>
                            <form method="post" asp-page-handler="Delete" asp-route-id="@c.Id" class="d-inline" onsubmit="confirmDelete(event, 'al cliente @c.Name @c.FirstLastname');">
                                <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
                            </form>
                        </div>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="createClientModal" tabindex="-1" aria-labelledby="createClientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createClientModalLabel">Registrar Nuevo Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="createClientModalBody">
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        // Función existente para confirmación de eliminación
        function confirmDelete(event, clientName) {
            event.preventDefault();
            const form = event.target;

            Swal.fire({
                title: '¿Estás seguro?',
                text: `¡Esta acción no se puede revertir! Se eliminará ${clientName}.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, ¡eliminar!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    form.submit();
                }
            });
        }

        // ---------------------------------------------
        // Lógica del Modal (Pop-up) para Creación
        // ---------------------------------------------

        const modalElement = document.getElementById('createClientModal');
        const modalBody = document.getElementById('createClientModalBody');

        // Función para recargar la página después de una creación exitosa
        function handleSuccess() {
            // Usa Bootstrap JS para cerrar el modal
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
            // Recargar la lista de clientes
            window.location.reload();
        }

        // 1. Cargar el formulario vía AJAX cuando el modal se abre
        modalElement.addEventListener('show.bs.modal', function (event) {
            // Llama al nuevo OnGetPartial para obtener solo el HTML del formulario
            fetch('/Clients/Create?handler=Partial')
                .then(response => response.text())
                .then(html => {

                    // Se inserta directamente el HTML del formulario parcial (sin encabezado ni card-body)
                    modalBody.innerHTML = html;

                    // 2. Rebind de la validación de jQuery para el nuevo contenido
                    const form = modalBody.querySelector('form');
                    if (form) {
                        // Limpiar y volver a aplicar la validación (necesario para contenido cargado dinámicamente)
                        if ($.validator) {
                            // Desvincula validación del formulario actual para evitar duplicados.
                            $(form).removeData("validator").removeData("unobtrusiveValidation");
                            // Aplica la validación al formulario cargado.
                            $.validator.unobtrusive.parse(form);
                        }

                        // 3. Capturar el envío del formulario cargado
                        form.addEventListener('submit', function (e) {
                            e.preventDefault();

                            // Verificar la validez antes de enviar
                            if ($(form).valid()) {

                                // Envío por AJAX
                                $.ajax({
                                    url: form.action,
                                    type: form.method,
                                    data: $(form).serialize(),
                                    contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                                    success: function (response) {
                                        // Si OnPostAsync fue exitoso, devuelve { success: true }
                                        if (response && response.success === true) {
                                            handleSuccess();
                                        } else {
                                            // Si la respuesta no es un JSON de éxito (ej: si OnPost devuelve Page()
                                            // con errores de validación), recarga el HTML con los errores.
                                            modalBody.innerHTML = response;
                                            // Rebind de la validación para el nuevo HTML (con errores)
                                            $.validator.unobtrusive.parse(modalBody.querySelector('form'));
                                        }
                                    },
                                    error: function (xhr, status, error) {
                                        // En caso de error HTTP, recarga el contenido del modal para mostrar el mensaje de error.
                                        modalBody.innerHTML = xhr.responseText;
                                        $.validator.unobtrusive.parse(modalBody.querySelector('form'));
                                    }
                                });
                            }
                        });
                    }
                })
                .catch(error => {
                    modalBody.innerHTML = '<div class="alert alert-danger">Error al cargar el formulario de cliente.</div>';
                    console.error('Error loading form:', error);
                });
        });

        // 4. Limpiar el modal al cerrarlo
        modalElement.addEventListener('hidden.bs.modal', function (event) {
            modalBody.innerHTML = `
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                `;
        });
    </script>
}