<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>GYM-CLAUDE · Login + JWT</title>
  <style>
    :root {
      --bg: #0d0f1a;
      --panel: #11162a;
      --accent: #7df9ff;
      --accent2: #ff7ad5;
      --text: #e6eaf5;
      --muted: #9ca8c0;
      --border: #1e2640;
      --glow: 0 0 25px rgba(125, 249, 255, 0.4);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', 'Inter', system-ui, sans-serif;
      background: radial-gradient(circle at 15% 20%, rgba(255,122,213,0.08), transparent 28%),
                  radial-gradient(circle at 80% 10%, rgba(125,249,255,0.12), transparent 32%),
                  linear-gradient(145deg, #0a0c16, #0f1223);
      color: var(--text);
      line-height: 1.6;
      padding: 40px clamp(16px, 4vw, 72px);
    }
    .deck {
      display: grid;
      gap: 18px;
      max-width: 1100px;
      margin: 0 auto;
    }
    .hero {
      padding: 28px;
      background: linear-gradient(135deg, rgba(125,249,255,0.08), rgba(255,122,213,0.06));
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--glow);
    }
    h1 { margin: 0 0 10px; letter-spacing: 0.5px; }
    h1 span { color: var(--accent); }
    p.lead { margin: 0; color: var(--muted); }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      position: relative;
      overflow: hidden;
    }
    .panel::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 10% 20%, rgba(125,249,255,0.06), transparent 30%),
                  radial-gradient(circle at 80% 10%, rgba(255,122,213,0.06), transparent 30%);
      pointer-events: none;
    }
    .panel h2 {
      margin: 0 0 10px;
      color: var(--accent);
      letter-spacing: 0.3px;
    }
    .panel h3 { margin: 14px 0 6px; color: var(--accent2); }
    ul { margin: 8px 0 0 18px; color: var(--muted); }
    li { margin-bottom: 4px; }
    code, .path {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      padding: 2px 6px;
      border-radius: 8px;
      font-family: 'Cascadia Code','JetBrains Mono',monospace;
      color: var(--accent);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 14px;
    }
    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(125,249,255,0.12);
      border: 1px solid rgba(125,249,255,0.35);
      color: var(--accent);
      font-size: 12px;
      letter-spacing: 0.2px;
    }
    .steps { counter-reset: step; }
    .steps li {
      counter-increment: step;
      list-style: none;
      position: relative;
      padding-left: 34px;
    }
    .steps li::before {
      content: counter(step);
      position: absolute; left: 0; top: 2px;
      width: 22px; height: 22px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: rgba(125,249,255,0.12);
      color: var(--accent);
      text-align: center;
      line-height: 22px;
      font-weight: 600;
    }
    a { color: var(--accent); text-decoration: none; }
  </style>
</head>
<body>
  <div class="deck">
    <div class="hero">
      <div class="badge">GYM-CLAUDE</div>
      <h1>Login + <span>JWT</span></h1>
      <p class="lead">Mapa rápido de cómo se autentica el sistema: generación de token, rutas clave y cómo WebUI reenvía el JWT.</p>
    </div>

    <div class="panel">
      <h2>Capas y rutas clave</h2>
      <div class="grid">
        <div>
          <h3>LoginMicroservice (API)</h3>
          <ul>
            <li><span class="path">LoginMicroservice/Controllers/LoginController.cs</span> → <code>POST /api/login</code></li>
            <li><span class="path">LoginMicroservice/Program.cs</span> → DI, Npgsql, JWT auth</li>
            <li><span class="path">LoginMicroservice/appsettings.json</span> → <code>Jwt:{Key,Issuer,Audience}</code>, <code>ConnectionStrings</code></li>
          </ul>
        </div>
        <div>
          <h3>Aplicación/Infra</h3>
          <ul>
            <li><span class="path">...Application/Services/LoginService.cs</span> → valida credenciales, emite token</li>
            <li><span class="path">...Infrastructure/Persistence/LoginRepository.cs</span> → verifica bcrypt ó SHA-256 en <code>users.user</code></li>
            <li><span class="path">...Infrastructure/Security/JwtTokenProvider.cs</span> → firma HMAC-SHA256</li>
          </ul>
        </div>
        <div>
          <h3>WebUI (front)</h3>
          <ul>
            <li><span class="path">WebUI/Pages/Login/Index.cshtml(.cs)</span> → pide token y guarda cookie (claims + token)</li>
            <li><span class="path">WebUI/Common/TokenMessageHandler.cs</span> → adjunta <code>Authorization: Bearer</code> en HttpClient</li>
            <li><span class="path">WebUI/Program.cs</span> → auth por cookies; HttpClients: LoginAPI, Users, Disciplines, ClientAPI</li>
            <li><span class="path">WebUI/Pages/Shared/_Layout.cshtml</span> → menú por rol</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>Flujo de autenticación</h2>
      <ul class="steps">
        <li>WebUI envía <code>{ email, password }</code> a <code>POST /api/login</code> (LoginAPI).</li>
        <li>LoginService valida formato (mín 5 chars) y llama al repositorio.</li>
        <li>LoginRepository busca en <code>users.user</code> (email lowercase) y verifica: <code>crypt</code> (bcrypt) o <code>encode(digest(sha256))</code>.</li>
        <li>JwtTokenProvider crea el token con claims: <code>sub</code>(Id), <code>unique_name</code>, <code>email</code>, <code>role</code>; vence en <code>Jwt:ExpiresMinutes</code>.</li>
        <li>WebUI recibe <code>{ token, expiresAt, user }</code>, crea cookie de auth y guarda el token como claim.</li>
        <li>TokenMessageHandler añade <code>Bearer &lt;token&gt;</code> en cada HttpClient (Users, Disciplines, ClientAPI).</li>
      </ul>
    </div>

    <div class="panel">
      <h2>Configuración mínima</h2>
      <div class="grid">
        <div>
          <h3>LoginMicroservice</h3>
          <ul>
            <li><code>ConnectionStrings:DefaultConnection</code> → BD usuarios</li>
            <li><code>Jwt:Key</code> → clave larga y secreta</li>
            <li><code>Jwt:Issuer/Audience</code> → debe coincidir con WebUI</li>
          </ul>
        </div>
        <div>
          <h3>WebUI</h3>
          <ul>
            <li><code>LoginApiBase</code> (p.ej. <code>http://localhost:5289</code>)</li>
            <li><code>UserApiBase</code>, <code>DisciplineApiBase</code>, <code>ClientApiBase</code></li>
          </ul>
        </div>
        <div>
          <h3>BD y seed</h3>
          <ul>
            <li>Usuarios seed: <span class="path">UserMicroservice/populate.sql</span> (ej: <code>admin@gmail.com / admin</code> SHA-256)</li>
            <li>Disciplinas: crear BD <code>DisciplineMicroserviceDB</code> y tabla <code>discipline</code></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>Rutas útiles (resumen)</h2>
      <ul>
        <li><code>Login API</code>: <span class="path">/api/login</span></li>
        <li><code>Users API</code>: <span class="path">/api/user</span> (microservicio de usuarios)</li>
        <li><code>Disciplines API</code>: <span class="path">/api/Disciplines</span></li>
        <li><code>WebUI Login</code>: <span class="path">/Login/Index</span></li>
      </ul>
      <p style="color:var(--muted); margin-top:10px;">Recomendación: mover <code>Jwt:Key</code> a variables de entorno y forzar HTTPS en despliegue.</p>
    </div>
  </div>
</body>
</html>
